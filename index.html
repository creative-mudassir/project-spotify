<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Playlist DJ ‚Äî Mood Recommender</title>

  <style>
    :root{
      /* default theme (neutral) */
      --bg1:#0b0f14;
      --bg2:#05070b;
      --card:#0f1722cc;
      --card2:#101826aa;
      --stroke:#223044;
      --text:#eaf2ff;
      --muted:#a8b3c7;
      --accent:#1DB954; /* spotify green */
      --accent2:#1ed760;
      --glow:rgba(29,185,84,.35);
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --radius: 18px;
    }

    /* Mood themes */
    body[data-mood="energetic"]{
      --bg1:#0b0f14; --bg2:#05070b;
      --accent:#ffb703; --accent2:#fb8500; --glow:rgba(255,183,3,.32);
    }
    body[data-mood="sad"]{
      --bg1:#070a12; --bg2:#04060c;
      --accent:#4ea8de; --accent2:#5390d9; --glow:rgba(78,168,222,.28);
    }
    body[data-mood="chill"]{
      --bg1:#071318; --bg2:#030a0d;
      --accent:#57cc99; --accent2:#38b000; --glow:rgba(87,204,153,.26);
    }
    body[data-mood="dance"]{
      --bg1:#100716; --bg2:#07020c;
      --accent:#ff4d6d; --accent2:#c77dff; --glow:rgba(199,125,255,.25);
    }
    body[data-mood="acoustic"]{
      --bg1:#10100a; --bg2:#070704;
      --accent:#e9c46a; --accent2:#f4a261; --glow:rgba(233,196,106,.22);
    }
    body[data-mood="electronic"]{
      --bg1:#070311; --bg2:#05010b;
      --accent:#00f5d4; --accent2:#00bbf9; --glow:rgba(0,245,212,.22);
    }
    body[data-mood="happy"]{
      --bg1:#0a120a; --bg2:#040804;
      --accent:#80ed99; --accent2:#57cc99; --glow:rgba(128,237,153,.24);
    }
    body[data-mood="relaxing"]{
      --bg1:#07101a; --bg2:#030711;
      --accent:#bde0fe; --accent2:#a2d2ff; --glow:rgba(162,210,255,.22);
    }
    body[data-mood="upbeat"]{
      --bg1:#0d0a14; --bg2:#05030a;
      --accent:#ffd60a; --accent2:#ff7b00; --glow:rgba(255,214,10,.22);
    }
    body[data-mood="melancholic"]{
      --bg1:#0b0f1a; --bg2:#050712;
      --accent:#9b5de5; --accent2:#5a189a; --glow:rgba(155,93,229,.24);
    }
    body[data-mood="slow"]{
      --bg1:#0b1016; --bg2:#04070c;
      --accent:#adb5bd; --accent2:#6c757d; --glow:rgba(173,181,189,.20);
    }
    body[data-mood="fast"]{
      --bg1:#120a0a; --bg2:#070303;
      --accent:#ff006e; --accent2:#ffbe0b; --glow:rgba(255,0,110,.22);
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(900px 600px at 20% 10%, var(--glow), transparent 55%),
        radial-gradient(900px 600px at 85% 25%, rgba(255,255,255,.04), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
      cursor:none; /* custom cursor enabled */
    }

    /* Custom cursor */
    .cursor-dot, .cursor-ring, .cursor-trail{
      position:fixed;
      top:0; left:0;
      pointer-events:none;
      z-index:9999;
      transform: translate(-50%, -50%);
      border-radius:50%;
      mix-blend-mode: screen;
    }
    .cursor-dot{
      width:8px; height:8px;
      background:var(--accent);
      box-shadow: 0 0 18px var(--glow);
    }
    .cursor-ring{
      width:34px; height:34px;
      border:1px solid rgba(255,255,255,.22);
      box-shadow: 0 0 18px rgba(255,255,255,.06);
      backdrop-filter: blur(8px);
    }
    .cursor-trail{
      width:14px; height:14px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), transparent 55%);
      border:1px solid rgba(255,255,255,.10);
      opacity:.7;
      filter: blur(.2px);
    }

    .app{
      min-height:100vh;
      display:flex;
    }

    /* Sidebar */
    .sidebar{
      width:320px;
      padding:26px 22px;
      border-right:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(14,18,28,.88), rgba(10,12,18,.70));
      backdrop-filter: blur(16px);
      position:fixed;
      top:0; left:0;
      height:100vh;
      overflow:auto;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      letter-spacing:.3px;
      font-size:22px;
      margin-bottom:20px;
    }
    .brand-badge{
      width:42px; height:42px;
      display:grid; place-items:center;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 12px 32px rgba(0,0,0,.45);
    }
    .brand span{
      color:var(--accent);
      text-shadow: 0 0 22px var(--glow);
    }
    .pill{
      margin-top:10px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .pill strong{
      color:var(--text);
      font-weight:800;
    }

    .section{
      margin-top:18px;
      padding-top:18px;
      border-top:1px solid rgba(255,255,255,.06);
    }
    .section h3{
      margin:0 0 10px 0;
      font-size:12px;
      letter-spacing:1.6px;
      text-transform:uppercase;
      color:rgba(255,255,255,.70);
    }
    .tracklist{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:62vh;
      overflow:auto;
      padding-right:8px;
    }
    .track{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      transition: transform .18s ease, border-color .18s ease, background .18s ease;
    }
    .track:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }
    .dot{
      width:10px; height:10px;
      border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 16px var(--glow);
      flex:0 0 auto;
    }
    .track .name{
      font-size:13px;
      color:rgba(255,255,255,.85);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Main */
    .main{
      flex:1;
      margin-left:320px;
      padding:44px 34px;
      max-width:1200px;
      width:100%;
    }

    .card{
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(135deg, var(--card), var(--card2));
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      overflow:hidden;
    }

    .setup{
      max-width:560px;
      margin:40px auto 0 auto;
      padding:26px;
    }

    .hero{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:16px;
    }
    .hero h1{
      margin:0;
      font-size:36px;
      letter-spacing:-.6px;
      line-height:1.05;
    }
    .hero h1 .accent{
      color:var(--accent);
      text-shadow: 0 0 22px var(--glow);
    }
    .hero p{
      margin:10px 0 0 0;
      color:var(--muted);
      line-height:1.55;
      font-size:14px;
    }
    .hero-icon{
      width:72px; height:72px;
      border-radius:20px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(40px 40px at 30% 20%, rgba(255,255,255,.18), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
      box-shadow: 0 22px 46px rgba(0,0,0,.55);
      font-size:28px;
    }

    .grid{
      display:grid;
      gap:14px;
      margin-top:14px;
    }
    .field label{
      display:block;
      font-weight:800;
      font-size:12px;
      letter-spacing:1.2px;
      text-transform:uppercase;
      color:rgba(255,255,255,.72);
      margin-bottom:8px;
    }
    .input{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
      transition: border-color .18s ease, transform .18s ease, box-shadow .18s ease;
    }
    .input:focus{
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 4px rgba(255,255,255,.05), 0 0 0 2px var(--glow);
      transform: translateY(-1px);
    }
    .hint{
      font-size:12px;
      color:rgba(255,255,255,.55);
      margin-top:6px;
      line-height:1.35;
    }

    .btn{
      width:100%;
      border:none;
      border-radius:999px;
      padding:12px 16px;
      font-weight:900;
      letter-spacing:.9px;
      text-transform:uppercase;
      cursor:pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#071009;
      box-shadow: 0 18px 40px var(--glow);
      transition: transform .18s ease, filter .18s ease;
      position:relative;
      overflow:hidden;
    }
    .btn:hover{ transform: translateY(-2px) scale(1.01); filter:saturate(1.05); }
    .btn:active{ transform: translateY(0px) scale(.99); }

    /* Ripple effect */
    .ripple{
      position:absolute;
      border-radius:50%;
      transform:translate(-50%,-50%);
      pointer-events:none;
      background: rgba(255,255,255,.35);
      animation:rip 650ms ease-out forwards;
    }
    @keyframes rip{
      from{ width:0; height:0; opacity:.55; }
      to{ width:320px; height:320px; opacity:0; }
    }

    /* Chat area */
    .chat{
      display:none;
    }
    .chat.active{
      display:block;
      max-width:860px;
      margin:10px auto 0 auto;
    }

    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }
    .title{
      margin:0;
      font-size:28px;
      letter-spacing:-.4px;
    }
    .subtitle{
      margin:6px 0 0 0;
      color:var(--muted);
      font-size:14px;
      line-height:1.4;
    }

    .mood-chip{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-size:13px;
      color:rgba(255,255,255,.85);
      white-space:nowrap;
    }
    .mood-emoji{
      font-size:18px;
      filter: drop-shadow(0 0 18px var(--glow));
    }

    .promptbox{
      margin-top:14px;
      padding:16px;
    }
    .prompts{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .tag{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:rgba(255,255,255,.82);
      font-size:13px;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .tag:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.22);
      background: rgba(255,255,255,.07);
    }

    .composer{
      display:flex;
      gap:10px;
      margin-top:16px;
      align-items:center;
    }
    .composer input{
      flex:1;
      padding:14px 16px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      transition: box-shadow .18s ease, border-color .18s ease;
    }
    .composer input:focus{
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 0 0 4px rgba(255,255,255,.05), 0 0 0 2px var(--glow);
    }
    .send{
      width:52px; height:52px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#071009;
      font-size:18px;
      font-weight:900;
      box-shadow: 0 16px 36px var(--glow);
      transition: transform .18s ease;
      position:relative;
      overflow:hidden;
    }
    .send:hover{ transform: translateY(-2px) scale(1.02); }
    .send:active{ transform: translateY(0) scale(.98); }

    .panel{
      margin-top:18px;
    }
    .loading{
      padding:18px;
      text-align:center;
      color:rgba(255,255,255,.85);
      font-weight:700;
    }
    .loading .spin{
      display:inline-block;
      margin-right:10px;
      animation: spin 900ms linear infinite;
    }
    @keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }

    .error, .success{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:rgba(255,255,255,.88);
    }
    .error{ border-color: rgba(255,80,80,.30); background: rgba(255,80,80,.08); }
    .success{ border-color: rgba(80,255,160,.26); background: rgba(80,255,160,.07); }

    .recs{
      margin-top:16px;
      display:grid;
      gap:12px;
    }
    .rec{
      padding:16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(600px 200px at 10% 0%, var(--glow), transparent 60%),
        rgba(255,255,255,.03);
      transition: transform .18s ease, border-color .18s ease;
    }
    .rec:hover{
      transform: translateY(-3px);
      border-color: rgba(255,255,255,.18);
    }
    .rec-top{
      display:flex;
      justify-content:space-between;
      gap:14px;
      align-items:flex-start;
    }
    .rec-title{
      margin:0;
      font-size:16px;
      font-weight:900;
      letter-spacing:-.2px;
    }
    .rec-artist{
      margin-top:6px;
      color:rgba(255,255,255,.70);
      font-size:13px;
    }
    .rec-genre{
      margin-top:10px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:rgba(255,255,255,.82);
    }
    .badge{
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#071009;
      box-shadow: 0 16px 36px var(--glow);
      white-space:nowrap;
    }

    .add{
      margin-top:14px;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:12px 16px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color:rgba(255,255,255,.90);
      font-weight:900;
      cursor:pointer;
      transition: transform .18s ease, border-color .18s ease, background .18s ease;
    }
    .add:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,.20);
      background: rgba(255,255,255,.08);
    }

    .footer-note{
      margin-top:14px;
      color:rgba(255,255,255,.55);
      font-size:12px;
    }

    /* Scrollbars */
    ::-webkit-scrollbar{ width:10px; }
    ::-webkit-scrollbar-track{ background: rgba(255,255,255,.03); }
    ::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.10); border-radius:999px; }
    ::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,.16); }

    /* Mobile */
    @media (max-width: 860px){
      body{ cursor:auto; }
      .cursor-dot, .cursor-ring, .cursor-trail{ display:none; }
      .sidebar{
        position:relative;
        width:100%;
        height:auto;
        border-right:none;
        border-bottom:1px solid rgba(255,255,255,.08);
      }
      .main{
        margin-left:0;
        padding:20px 16px 46px 16px;
      }
      .setup{ margin-top:20px; }
    }
  </style>
</head>

<body data-mood="neutral">
  <!-- Custom cursor -->
  <div class="cursor-dot" id="cursorDot"></div>
  <div class="cursor-ring" id="cursorRing"></div>
  <div class="cursor-trail" id="cursorTrail"></div>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-badge">‚ô´</div>
        <div>
          Playlist DJ<br/>
          <span>AI Mood</span>
        </div>
      </div>
      <div class="pill">
        <span>üéöÔ∏è</span>
        <span>Theme:</span>
        <strong id="themeLabel">Neutral</strong>
      </div>

      <div class="section">
        <h3>üìª Your Playlist</h3>
        <div class="tracklist" id="playlistTracks">
          <div class="track">
            <div class="dot"></div>
            <div class="name" style="opacity:.65;">Upload CSV to start‚Ä¶</div>
          </div>
        </div>
      </div>

      <div class="section">
        <h3>‚ö° Tips</h3>
        <div style="color:rgba(255,255,255,.65); font-size:13px; line-height:1.55;">
          Use moods like <b>energetic</b>, <b>sad</b>, <b>chill</b>, <b>dance</b>, <b>acoustic</b>, <b>electronic</b>‚Ä¶
          <div class="footer-note">Theme changes automatically after search ‚ú®</div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">

      <!-- Setup -->
      <section class="card setup" id="setupSection">
        <div class="hero">
          <div>
            <h1>Playlist <span class="accent">DJ</span></h1>
            <p>Upload your Spotify features CSV and describe a vibe. UI will shift colors by mood + show emojis + glow cursor.</p>
          </div>
          <div class="hero-icon">üéß</div>
        </div>

        <div class="grid">
          <div class="field">
            <label>üìÅ Upload CSV File</label>
            <input class="input" type="file" id="csvFile" accept=".csv" required />
            <div class="hint">Your dataset should have audio features columns (energy, valence, tempo, etc.)</div>
          </div>

          <div class="field">
            <label>üîë Hugging Face API Key (Optional)</label>
            <input class="input" type="password" id="apiKey" placeholder="Leave blank for basic mode" />
            <div class="hint">If blank, the app uses keyword mood rules.</div>
          </div>

          <button class="btn" id="startBtn">Get Started</button>
        </div>
      </section>

      <!-- Chat -->
      <section class="chat" id="chatSection">
        <div class="topbar">
          <div>
            <h2 class="title">‚ú® Discover New Music</h2>
            <p class="subtitle">Type a mood prompt. After results, theme & emoji update automatically.</p>
          </div>

          <div class="mood-chip">
            <span class="mood-emoji" id="moodEmoji">üéõÔ∏è</span>
            <span id="moodText">Neutral</span>
          </div>
        </div>

        <div class="card promptbox">
          <div style="font-weight:900; letter-spacing:.8px; text-transform:uppercase; font-size:12px; color:rgba(255,255,255,.72);">
            üí° Quick moods
          </div>
          <div class="prompts" id="promptTags">
            <div class="tag" data-tag="energetic">‚ö° energetic</div>
            <div class="tag" data-tag="sad">üåßÔ∏è sad</div>
            <div class="tag" data-tag="chill">üßä chill</div>
            <div class="tag" data-tag="dance">ü™© dance</div>
            <div class="tag" data-tag="acoustic">ü™µ acoustic</div>
            <div class="tag" data-tag="electronic">ü§ñ electronic</div>
            <div class="tag" data-tag="upbeat">üòÑ upbeat</div>
            <div class="tag" data-tag="melancholic">üåô melancholic</div>
            <div class="tag" data-tag="relaxing">üåø relaxing</div>
            <div class="tag" data-tag="happy">‚òÄÔ∏è happy</div>
            <div class="tag" data-tag="slow">üê¢ slow</div>
            <div class="tag" data-tag="fast">üèéÔ∏è fast</div>
          </div>

          <div class="composer">
            <input type="text" id="userMessage" placeholder="Describe the mood you want‚Ä¶ e.g. chill & relaxing" />
            <button class="send" id="sendBtn">‚Üí</button>
          </div>
        </div>

        <div class="panel" id="messageResponse"></div>
      </section>

    </main>
  </div>

  <script>
    // ‚úÖ Set your API base (local or deployed)
    // const API_BASE = ""; // local (same origin)
    const API_BASE = "https://project-spotify-production.up.railway.app";

    let currentRecommendations = [];

    // ---------- Mood detection + Theme ----------
    const MOODS = [
      { key:"energetic",   emoji:"‚ö°", label:"Energetic" },
      { key:"sad",         emoji:"üåßÔ∏è", label:"Sad" },
      { key:"chill",       emoji:"üßä", label:"Chill" },
      { key:"dance",       emoji:"ü™©", label:"Dance" },
      { key:"acoustic",    emoji:"ü™µ", label:"Acoustic" },
      { key:"electronic",  emoji:"ü§ñ", label:"Electronic" },
      { key:"upbeat",      emoji:"üòÑ", label:"Upbeat" },
      { key:"melancholic", emoji:"üåô", label:"Melancholic" },
      { key:"relaxing",    emoji:"üåø", label:"Relaxing" },
      { key:"happy",       emoji:"‚òÄÔ∏è", label:"Happy" },
      { key:"slow",        emoji:"üê¢", label:"Slow" },
      { key:"fast",        emoji:"üèéÔ∏è", label:"Fast" },
    ];

    function detectMood(text){
      const t = (text || "").toLowerCase();
      for(const m of MOODS){
        if(t.includes(m.key)) return m;
      }
      // small extras
      if(t.includes("calm")) return {key:"relaxing", emoji:"üåø", label:"Relaxing"};
      if(t.includes("party")) return {key:"dance", emoji:"ü™©", label:"Dance"};
      return {key:"neutral", emoji:"üéõÔ∏è", label:"Neutral"};
    }

    function applyMood(mood){
      document.body.setAttribute("data-mood", mood.key);
      document.getElementById("moodEmoji").textContent = mood.emoji;
      document.getElementById("moodText").textContent = mood.label;
      document.getElementById("themeLabel").textContent = mood.label;
    }

    // ---------- Ripple on buttons ----------
    function addRipple(el, x, y){
      const r = document.createElement("span");
      r.className = "ripple";
      const rect = el.getBoundingClientRect();
      r.style.left = (x - rect.left) + "px";
      r.style.top  = (y - rect.top) + "px";
      el.appendChild(r);
      setTimeout(() => r.remove(), 700);
    }

    // ---------- Initialize ----------
    const startBtn = document.getElementById("startBtn");
    startBtn.addEventListener("click", async (e) => {
      addRipple(startBtn, e.clientX, e.clientY);

      const csvFile = document.getElementById("csvFile").files[0];
      const apiKey = document.getElementById("apiKey").value;

      if(!csvFile){
        alert("Please select a CSV file");
        return;
      }

      const formData = new FormData();
      formData.append("csv_file", csvFile);
      formData.append("api_key", apiKey);

      try{
        const res = await fetch(`${API_BASE}/api/initialize`, { method:"POST", body: formData });
        const result = await res.json();

        if(result.success){
          document.getElementById("setupSection").style.display = "none";
          const chat = document.getElementById("chatSection");
          chat.classList.add("active");
          applyMood({key:"neutral", emoji:"üéõÔ∏è", label:"Neutral"});
          updatePlaylist();
        }else{
          alert("Error: " + result.error);
        }
      }catch(err){
        alert("Connection error: " + err.message);
      }
    });

    // ---------- Quick tags ----------
    document.getElementById("promptTags").addEventListener("click", (e) => {
      const tag = e.target.closest(".tag");
      if(!tag) return;
      const value = tag.dataset.tag;
      document.getElementById("userMessage").value = value;
      document.getElementById("userMessage").focus();
    });

    // ---------- Send message ----------
    const sendBtn = document.getElementById("sendBtn");
    sendBtn.addEventListener("click", async (e) => {
      addRipple(sendBtn, e.clientX, e.clientY);
      await sendMessage();
    });

    document.getElementById("userMessage").addEventListener("keypress", (e) => {
      if(e.key === "Enter") sendMessage();
    });

    async function sendMessage(){
      const input = document.getElementById("userMessage");
      const message = input.value.trim();
      if(!message) return;

      const mood = detectMood(message);
      applyMood(mood);

      const panel = document.getElementById("messageResponse");
      panel.innerHTML = `
        <div class="card" style="padding:16px;">
          <div class="loading"><span class="spin">‚è≥</span> ${mood.emoji} Finding the perfect tracks‚Ä¶</div>
        </div>
      `;

      try{
        const res = await fetch(`${API_BASE}/api/chat`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ message })
        });

        const result = await res.json();

        if(result.success){
          input.value = "";
          displayRecommendations(result, mood);
        }else{
          panel.innerHTML = `<div class="error">‚ùå ${result.error}</div>`;
        }
      }catch(err){
        panel.innerHTML = `<div class="error">‚ùå ${err.message}</div>`;
      }
    }

    function displayRecommendations(result, mood){
      const top5 = (result.new_recommendations || []).slice(0,5);
      currentRecommendations = top5;

      let html = `
        <div class="card" style="padding:18px;">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <div style="font-size:20px;">${mood.emoji}</div>
            <div style="font-weight:900; font-size:16px;">
              üéØ ${result.interpretation || "Recommendations"}
            </div>
          </div>
          <div style="color:rgba(255,255,255,.70); font-size:13px; line-height:1.5;">
            Theme updated to <b>${mood.label}</b>. Click ‚ÄúAdd Top 5‚Äù to push into playlist list.
          </div>
        </div>
      `;

      if(top5.length){
        html += `<div class="recs">`;
        top5.forEach((t,i) => {
          const pct = Math.round((t.similarity || 0) * 100);
          html += `
            <div class="rec">
              <div class="rec-top">
                <div>
                  <p class="rec-title">${i+1}. ${escapeHtml(t.name || "Unknown")}</p>
                  <div class="rec-artist">${escapeHtml(t.artist || "Unknown Artist")}</div>
                  <div class="rec-genre">üè∑Ô∏è ${escapeHtml(t.genre || "Unknown")}</div>
                </div>
                <div class="badge">${pct}%</div>
              </div>
            </div>
          `;
        });
        html += `</div>`;

        html += `<button class="add" onclick="addTracks()">‚ûï Add Top 5 to Playlist</button>`;
      }else{
        html += `<div class="error">No recommendations returned.</div>`;
      }

      document.getElementById("messageResponse").innerHTML = html;
    }

    async function addTracks(){
      const indices = currentRecommendations.map(t => t.index);
      if(!indices.length) return;

      try{
        const res = await fetch(`${API_BASE}/api/add-tracks`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ indices })
        });

        const result = await res.json();
        if(result.success){
          const panel = document.getElementById("messageResponse");
          panel.innerHTML += `<div class="success">‚úÖ Tracks added to your playlist!</div>`;
          updatePlaylist();
        }else{
          alert("Error: " + (result.error || "Failed"));
        }
      }catch(err){
        alert("Error adding tracks: " + err.message);
      }
    }

    async function updatePlaylist(){
      try{
        const res = await fetch(`${API_BASE}/api/playlist`);
        const result = await res.json();

        const holder = document.getElementById("playlistTracks");
        let html = "";

        if(result.tracks && result.tracks.length){
          result.tracks.forEach(track => {
            html += `
              <div class="track">
                <div class="dot"></div>
                <div class="name">üéµ ${escapeHtml(track.name || "Unknown")}</div>
              </div>
            `;
          });
        }else{
          html = `
            <div class="track">
              <div class="dot" style="opacity:.45;"></div>
              <div class="name" style="opacity:.65;">No tracks yet</div>
            </div>
          `;
        }

        holder.innerHTML = html;
      }catch(err){
        // silent
        console.error("playlist update err:", err);
      }
    }

    setInterval(updatePlaylist, 2000);

    // ---------- Custom cursor (dot + ring + trail) ----------
    const dot = document.getElementById("cursorDot");
    const ring = document.getElementById("cursorRing");
    const trail = document.getElementById("cursorTrail");

    let mx=0, my=0, rx=0, ry=0, tx=0, ty=0;

    window.addEventListener("mousemove", (e)=>{
      mx = e.clientX; my = e.clientY;
      dot.style.left = mx+"px";
      dot.style.top  = my+"px";
    });

    function animate(){
      // ring follows smoothly
      rx += (mx - rx) * 0.16;
      ry += (my - ry) * 0.16;
      ring.style.left = rx+"px";
      ring.style.top  = ry+"px";

      // trail slower
      tx += (mx - tx) * 0.08;
      ty += (my - ty) * 0.08;
      trail.style.left = tx+"px";
      trail.style.top  = ty+"px";

      requestAnimationFrame(animate);
    }
    animate();

    // Cursor "press" effect
    window.addEventListener("mousedown", ()=>{
      ring.style.transform = "translate(-50%,-50%) scale(.85)";
    });
    window.addEventListener("mouseup", ()=>{
      ring.style.transform = "translate(-50%,-50%) scale(1)";
    });

    // ---------- Helpers ----------
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }
  </script>
</body>
</html>
