<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spotify AI Recommender</title>

  <style>
    /* aapka pura CSS yahan same as-is paste kar sakte ho */
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:#0f0f0f;color:#fff;min-height:100vh;overflow-x:hidden;}
    .app-container{display:flex;min-height:100vh;}
    .sidebar{width:300px;background:#121212;padding:24px;border-right:1px solid #282828;overflow-y:auto;position:fixed;height:100vh;left:0;top:0;}
    .logo{font-size:24px;font-weight:900;margin-bottom:30px;color:#1DB954;display:flex;align-items:center;gap:8px;}
    .playlist-section{margin-bottom:30px;}
    .playlist-section h3{font-size:12px;font-weight:700;text-transform:uppercase;color:#b3b3b3;margin-bottom:12px;letter-spacing:1.5px;}
    .track-list-sidebar{max-height:400px;overflow-y:auto;}
    .track-item-sidebar{padding:10px 0;border-bottom:1px solid #282828;font-size:13px;color:#b3b3b3;cursor:pointer;transition:color .2s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .track-item-sidebar:hover{color:#fff;}
    .main-content{flex:1;margin-left:300px;padding:40px;max-width:1200px;}
    .setup-section{display:none;max-width:500px;margin:0 auto;text-align:center;}
    .setup-section.active{display:block;}
    .setup-section h1{font-size:2.5em;margin-bottom:15px;background:linear-gradient(135deg,#1DB954,#1ed760);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:900;}
    .setup-section p{color:#b3b3b3;margin-bottom:40px;font-size:1.05em;}
    .form-group{margin-bottom:20px;text-align:left;}
    .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#fff;font-size:.95em;}
    .form-group input{width:100%;padding:12px 15px;border:1px solid #282828;border-radius:8px;font-size:1em;background:#282828;color:#fff;transition:all .3s;}
    .btn{background:#1DB954;color:#000;border:none;padding:12px 32px;border-radius:24px;font-size:1em;font-weight:700;cursor:pointer;transition:all .3s;width:100%;text-transform:uppercase;letter-spacing:.5px;}
    .btn-send{width:50px;height:50px;border-radius:50%;padding:0;display:flex;align-items:center;justify-content:center;font-size:1.2em;}
    .chat-section{display:none;}
    .chat-section.active{display:block;}
    .keywords{background:#282828;padding:20px;border-radius:12px;margin-bottom:30px;}
    .keywords strong{display:block;margin-bottom:10px;color:#1DB954;}
    .chat-input-container{display:flex;gap:12px;margin-bottom:30px;}
    .chat-input-container input{flex:1;padding:14px 18px;border:1px solid #282828;border-radius:24px;font-size:1em;background:#282828;color:#fff;}
    .loading{text-align:center;color:#1DB954;font-weight:600;padding:40px;font-size:1.1em;}
    .error{background:#3e1f1f;color:#ff6b6b;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #ff6b6b;}
    .success{background:#1a3e1a;color:#51cf66;padding:15px;border-radius:8px;margin-bottom:20px;border-left:4px solid #51cf66;}
    @media(max-width:768px){.sidebar{width:100%;height:auto;position:relative;border-right:none;border-bottom:1px solid #282828}.main-content{margin-left:0;padding:20px}}
  </style>
</head>

<body>
  <div class="app-container">
    <div class="sidebar">
      <div class="logo">‚ô´ Playlist DJ</div>

      <div class="playlist-section">
        <h3>üìª Your Playlist</h3>
        <div class="track-list-sidebar" id="playlistTracks">
          <div class="track-item-sidebar" style="color:#666;">Your playlist will appear here</div>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="setup-section active" id="setupSection">
        <div class="logo" style="justify-content:center; margin-bottom:30px; font-size:48px;">‚ô´</div>
        <h1>Playlist DJ</h1>
        <p>Transform your music with AI-powered mood recommendations</p>

        <div class="form-group">
          <label>üìÅ Upload CSV File</label>
          <input type="file" id="csvFile" accept=".csv" required />
          <small>Your Spotify features dataset</small>
        </div>

        <div class="form-group">
          <label>üîë Hugging Face API Key (Optional)</label>
          <input type="password" id="apiKey" placeholder="Leave blank for basic mode" />
        </div>

        <button class="btn" onclick="initializeApp()">Get Started</button>
      </div>

      <div class="chat-section" id="chatSection">
        <h2 class="header-title">‚ú® Discover New Music</h2>

        <div class="keywords">
          <strong>üí° Try these mood prompts:</strong>
          <p>energetic ‚Ä¢ sad ‚Ä¢ acoustic ‚Ä¢ chill ‚Ä¢ dance ‚Ä¢ electronic ‚Ä¢ upbeat ‚Ä¢ melancholic ‚Ä¢ relaxing ‚Ä¢ happy ‚Ä¢ slow ‚Ä¢ fast</p>
        </div>

        <div class="chat-input-container">
          <input type="text" id="userMessage" placeholder="Describe the mood you want..." onkeypress="handleEnter(event)" />
          <button class="btn btn-send" onclick="sendMessage()">‚Üí</button>
        </div>

        <div id="messageResponse"></div>
      </div>
    </div>
  </div>

  <script>
    let currentRecommendations = [];
    const API_BASE = "https://project-spotify-production.up.railway.app"; // ‚úÖ same domain: https://project-spotify-production.up.railway.app

    async function initializeApp() {
      const csvFile = document.getElementById("csvFile").files[0];
      const apiKey = document.getElementById("apiKey").value;

      if (!csvFile) {
        alert("Please select a CSV file");
        return;
      }

      const formData = new FormData();
      formData.append("csv_file", csvFile);
      formData.append("api_key", apiKey);

      try {
        const response = await fetch(`${API_BASE}/api/initialize`, { method: "POST", body: formData });
        const result = await response.json();

        if (!response.ok || !result.success) {
          alert("Init failed: " + (result.error || response.status));
          return;
        }

        document.getElementById("setupSection").classList.remove("active");
        document.getElementById("chatSection").classList.add("active");

        updatePlaylist();
        setInterval(updatePlaylist, 2000);

      } catch (err) {
        alert("Connection error: " + err.message);
      }
    }

    async function sendMessage() {
      const message = document.getElementById("userMessage").value.trim();
      if (!message) return;

      document.getElementById("messageResponse").innerHTML =
        '<div class="loading">üéµ Finding the perfect tracks...</div>';

      try {
        const response = await fetch(`${API_BASE}/api/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message }),
        });

        const result = await response.json();

        if (result.success) {
          displayRecommendations(result);
          document.getElementById("userMessage").value = "";
        } else {
          document.getElementById("messageResponse").innerHTML =
            `<div class="error">‚ùå ${result.error}</div>`;
        }
      } catch (err) {
        document.getElementById("messageResponse").innerHTML =
          `<div class="error">‚ùå ${err.message}</div>`;
      }
    }

    function displayRecommendations(result) {
      let html = `<h3>üéØ ${result.interpretation}</h3>`;

      if (result.new_recommendations && result.new_recommendations.length > 0) {
        html += '<div class="recommendations"><h3>Top Matches</h3>';

        result.new_recommendations.slice(0, 5).forEach((track, i) => {
          html += `
            <div class="rec-item" style="background:linear-gradient(135deg,#282828 0%,#1a1a1a 100%);padding:20px;border-radius:12px;border:1px solid #282828;margin-bottom:15px;">
              <div style="display:flex;justify-content:space-between;align-items:start;gap:10px;">
                <div style="flex:1;">
                  <strong>${i + 1}. ${track.name}</strong>
                  <div style="color:#b3b3b3;">${track.artist}</div>
                  <div style="color:#1DB954;">${track.genre}</div>
                </div>
                <div class="similarity-badge">${Math.round(track.similarity * 100)}%</div>
              </div>
            </div>
          `;
        });

        html += "</div>";
        currentRecommendations = result.new_recommendations.slice(0, 5);

        html += `<button class="btn" style="margin-top:10px;" onclick="addTracks()">‚ûï Add Top 5 to Playlist</button>`;
      }

      document.getElementById("messageResponse").innerHTML = html;
    }

    async function addTracks() {
      const indices = currentRecommendations.map((t) => t.index);

      try {
        const response = await fetch(`${API_BASE}/api/add-tracks`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ indices }),
        });

        const result = await response.json();

        if (result.success) {
          document.getElementById("messageResponse").innerHTML +=
            '<div class="success">‚úÖ Tracks added to your playlist!</div>';
          updatePlaylist();
        } else {
          alert(result.error || "Failed to add tracks");
        }
      } catch (err) {
        alert("Error adding tracks: " + err.message);
      }
    }

    async function updatePlaylist() {
      try {
        const response = await fetch(`${API_BASE}/api/playlist`);
        const result = await response.json();

        if (!result.initialized) return;

        let html = "";
        if (result.tracks && result.tracks.length > 0) {
          result.tracks.forEach((track) => {
            html += `<div class="track-item-sidebar">üéµ ${track.name}</div>`;
          });
        } else {
          html = '<div class="track-item-sidebar" style="color:#666;">No tracks yet</div>';
        }

        document.getElementById("playlistTracks").innerHTML = html;
      } catch (err) {
        console.error("Error updating playlist:", err);
      }
    }

    function handleEnter(event) {
      if (event.key === "Enter") sendMessage();
    }
  </script>
</body>
</html>
